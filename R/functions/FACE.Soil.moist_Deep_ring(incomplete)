#moistyre at a depth of 30 cm

#function which extract specified parameters from a dataset
ex_variable <- function(data,variables){
  result <- data[grep(variables,names(data))]
  means <- melt(result,id=c("Date","ring","co2"))
  ring_mean<-with(means,aggregate(value,list(Date=Date,ring=ring,co2=co2),mean))
  names(ring_mean)[4]<-"moist"
  ring_mean<-ring_mean[order(ring_mean$Date),]
  head(ring_mean)
  ring_mean$moist<-ring_mean$moist/100 #convert the unit to fraction
  return(ring_mean)
}

#function which combine nwe data and preivious data, and then produce a graph
DeepSoilMoist_graphs <- function(filename,parameters,savefile,figname,figtitle){
  if(!file.exists(savefile)){
    filename <- ex_variable(data=allsoil,variables=parameters)
    save(filename,file=savefile)
  } else{
    newdata <- ex_variable(data=newsoilData,variables=parameters)
    load(savefile)
    filename <- rbind(filename,newdata)
    filename <- filename[!duplicated(filename),]#remove duplicates
    filename <- filename[order(filename$Date),]#re-order accoding to date
    save(filename,file=savefile)
  }
  
  fname<-paste(figname,months(max(ring.means$Date),abbreviate=TRUE),year(max(ring.means$Date)),".png",sep="")
  png(file=fname,height=600,width=1200)
  moist_graph.png(dataset=filename,title=figtitle,legend.location="topleft")
  dev.off()
  
  return(filename)
}

mo30.ring <- DeepSoilMoist_graphs(filename="mo30.ring",
                                  parameters="Date$|ring|co2|Theta30",
                                  savefile="output/mo30.ring.Rdata",
                                  figname="Figs/FACE.Soil.moist_30cm_ring.",
                                  figtitle="Soil moisture at 30 cm")

mo75.ring <- DeepSoilMoist_graphs(filename="mo75.ring",
                                  parameters="Date$|ring|co2|Theta75",
                                  savefile="output/mo75.ring.Rdata",
                                  figname="Figs/FACE.Soil.moist_75cm_ring.",
                                  figtitle="Soil moisture at 75 cm")

mo_HL.ring <- DeepSoilMoist_graphs(filename="mo_HL.ring",
                                   parameters="Date$|ring|co2|ThetaHL",
                                   savefile="output/mo_HL.ring.Rdata",
                                   figname="Figs/FACE.Soil.moist_HL_ring.",
                                   figtitle="Soil moisture at HL")
